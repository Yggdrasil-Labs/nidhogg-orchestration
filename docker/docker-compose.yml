name: Yggdrasil-Labs
services:
  nacos-standalone-derby:
    image: nacos/nacos-server:v3.0.3
    container_name: nacos-standalone-derby
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
      - NACOS_AUTH_ENABLE=${NACOS_AUTH_ENABLE:-true}
      - NACOS_AUTH_TOKEN=${NACOS_AUTH_TOKEN:-nacos}
      - NACOS_AUTH_IDENTITY_KEY=${NACOS_AUTH_IDENTITY_KEY:-nacos}
      - NACOS_AUTH_IDENTITY_VALUE=${NACOS_AUTH_IDENTITY_VALUE:-nacos}
    volumes:
      - nacos-data:/home/nacos/data
      - nacos-logs:/home/nacos/logs
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8848/nacos/v1/console/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - Yggdrasil-net
  valhalla-auth:
    image: ghcr.io/yggdrasil-labs/valhalla-auth:latest
    container_name: valhalla-auth
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${AUTH_HTTP_PORT:-8081}:8081"  # HTTP 端口
      - "${AUTH_SERVICE_PORT:-20880}:20880"  # Dubbo 服务端口
    environment:
      - JAVA_OPTS=${AUTH_JAVA_OPTS:--Xms128m -Xmx256m -XX:+UseSerialGC -XX:MaxRAM=512m}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-production}
      # Nacos 服务地址（同一网络内使用容器名）
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos-standalone-derby:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos-standalone-derby:8848
      # Nacos 认证（服务端开启鉴权时必填，默认 nacos/nacos）
      - SPRING_CLOUD_NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - SPRING_CLOUD_NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - SPRING_CLOUD_NACOS_CONFIG_NAMESPACE=${DUBBO_NAMESPACE:-production}
      # Dubbo 配置（地址中需带 Nacos 用户名密码，否则鉴权开启时 Naming Service 不可用）
      - DUBBO_REGISTRY_ADDRESS=${DUBBO_REGISTRY_ADDRESS:-nacos://nacos-standalone-derby:8848?username=nacos&password=nacos}
      - DUBBO_NAMESPACE=${DUBBO_NAMESPACE:-production}
      - DUBBO_GROUP=${DUBBO_GROUP:-valhalla-auth}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - Yggdrasil-net
  valhalla-user:
    image: yggdrasil-labs/valhalla-user:latest
    container_name: valhalla-user
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${USER_HTTP_PORT:-8082}:8081"  # HTTP 端口
      - "${USER_SERVICE_PORT:-20881}:20880"  # Dubbo 服务端口
    environment:
      - JAVA_OPTS=${USER_JAVA_OPTS:--Xms128m -Xmx256m -XX:+UseSerialGC -XX:MaxRAM=512m}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-production}
      # Nacos 服务地址（同一网络内使用容器名）
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos-standalone-derby:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos-standalone-derby:8848
      # Nacos 认证（服务端开启鉴权时必填，默认 nacos/nacos）
      - SPRING_CLOUD_NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - SPRING_CLOUD_NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - SPRING_CLOUD_NACOS_CONFIG_NAMESPACE=${DUBBO_NAMESPACE:-production}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - Yggdrasil-net
  valhalla-user-admin:
    image: ghcr.io/yggdrasil-labs/valhalla-user-admin:latest
    container_name: valhalla-user-admin
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${FRONTEND_PORT:-8080}:80"  # 前端 HTTP 端口
    environment:
      # 前端运行时覆盖 API 地址（与镜像约定的 VITE_API_BASE_URL 一致，同一镜像多环境无需重构建）
      - VITE_API_BASE_URL=${ADMIN_API_BASE_URL:-https://api.yggdrasil-labs.com}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - Yggdrasil-net
networks:
  Yggdrasil-net:
    driver: bridge
    name: Yggdrasil-net
volumes:
  nacos-data:
  nacos-logs:
